steps:
  - script: |
      echo "=== Get agent IP ==="
      echo '##vso[task.setvariable variable=agent_ip]$(curl -s https://ipinfo.io/json | jq -r .ip)'
    displayName: "Get agent IP"
  - script: |
      echo "=== Update deployer NSG source address with agent IP ==="
      rg_name=${{parameters.deployer_rg_name}}
      az login --service-principal --user $(hana-pipeline-spn-id) --password $(hana-pipeline-spn-pw) --tenant $(landscape-tenant) --output none
      prefix_list=$(az network nsg rule show  -g $rg_name --nsg-name nsg-mgmt -n ssh | jq -r '.sourceAddressPrefix, (.sourceAddressPrefixes | join(" ")) | select(.!=null)')
      az network nsg rule update -g $rg_name --nsg-name nsg-mgmt -n ssh --source-address-prefixes $(agent_ip) $prefix_list --output none
    displayName: "Add agent IP to deployer NSG"
    env:
      ARM_CLIENT_ID: $(hana-pipeline-spn-id)
      ARM_CLIENT_SECRET: $(hana-pipeline-spn-pw)
      ARM_TENANT_ID: $(landscape-tenant)
      ARM_SUBSCRIPTION_ID: $(landscape-subscription)
