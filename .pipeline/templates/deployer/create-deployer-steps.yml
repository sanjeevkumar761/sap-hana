steps:
  - script: |
      cd deploy/terraform/bootstrap/sap_deployer
      rg_name=${{parameters.deployer_rg_name}}
      echo "##vso[task.setvariable variable=deployer_rg;isOutput=true]$rg_name"
      cat deployer.json | jq --arg allowed_ip "$(agent_ip)" --arg rg_name "$rg_name" '.infrastructure += {
        resource_group: {
          name: $rg_name
        },
        vnets: {
          management: {
            subnet_mgmt: {
              nsg: {
                allowed_ips: ["67.160.0.0/16", $allowed_ip]
                }
              }
            }
          }
        }' > updated_deployer.json
      
      echo "=== Start terraform apply for new deployer ==="
      terraform -version
      terraform init
      terraform apply -auto-approve -var-file=updated_deployer.json
    name: setDeployerRg
    displayName: "Deploy new deployer"
    env:
      ARM_CLIENT_ID: $(hana-pipeline-spn-id)
      ARM_CLIENT_SECRET: $(hana-pipeline-spn-pw)
      ARM_TENANT_ID: $(landscape-tenant)
      ARM_SUBSCRIPTION_ID: $(landscape-subscription)